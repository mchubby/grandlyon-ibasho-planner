<!doctype html>
<html lang="en">
<head>
  <title>Slippy Map of Grand Lyon Public Transport</title>
    <link rel="stylesheet" href="css/ribbon.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
  <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
  <![endif]-->
  <script src="//code.jquery.com/jquery-2.0.0.min.js"></script>
  <!-- <link href='http://fonts.googleapis.com/css?family=Milonga' rel='stylesheet' type='text/css'> -->
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" href="vendor/Leaflet.awesome-markers-2.0-develop/dist/leaflet.awesome-markers.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" /> <style type="text/css">
    body {
        padding: 0;
        margin: 0;
    }
    html, body, #map {
        height: 100%;
        /* font-family: 'Milonga', cursive; */
    }
    .leaflet-container .leaflet-control-zoom {
        margin-left: 13px;
        /* margin-top: 70px; */
    }
    .infoctrl {
        min-width: 200px;
        padding: 6px 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        background: white;
        background: rgba(255,255,255,0.8);
        text-align: center;
    }

    .infoctrl h4 {
        margin:2px 5px 2px 0;
        text-shadow: 0 -1px 1px rgba(0, 0, 0, 0.15);
        font-family: "Helvetica Neue",Arial,Helvetica,sans-serif;
        font-size: 1.1em;
        color: #222;
    }
    .infoctrl h4:nth-child(1) {
        border-radius: 15px;
        background-color: gold;
    }
    .infoctrl a {
        font-size: .9em;
        text-decoration: none;
    }
 
    #map { z-index: 1;}
    #title { z-index: 2; position: absolute; left: 10px; }
  </style>
 
</head>
<body>
  <h1 id="title" style="display:none">National Parks</h1>
  <div id="map"></div>
  <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
  <script src="vendor/Leaflet.awesome-markers-2.0-develop/dist/leaflet.awesome-markers.js"></script>
  <script>
    var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    });
    var mapbox_attr_str = 'Imagery from <a href="http://mapbox.com/about/maps/">MapBox</a> &mdash; ' +
         'Map data &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    var mapbox_basemap = L.tileLayer('http://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
        id: 'examples.map-9ijuk24y',
        attribution: mapbox_attr_str
    });
    var mapbox_greymap = L.tileLayer('http://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
        id: 'examples.map-20v6611k',
        attribution: mapbox_attr_str
    });
    var markerLayerGroup = new L.layerGroup();

    var baseLayers = {
        "Open<b>Street</b>Map": osm,
        "MapBox -Base Map-": mapbox_basemap,
        "MapBox -Grey Map-": mapbox_greymap
    };
    var poiLayers = {
        "TCL M&eacute;tro A": markerLayerGroup
    };
    
    var InfoControl = L.Control.extend({
        options: {
            position: 'topleft'
        },

        onAdd: function (map) {
            this._div = L.DomUtil.create('div', 'infoctrl leaflet-control leaflet-control-layers leaflet-control-layers-expanded');
            this.update();
            L.DomEvent.on(this._div, 'mousewheel', L.DomEvent.stopPropagation);
            L.DomEvent.disableClickPropagation(this._div);
            return this._div;
        },
        
        update: function (props) {
//#jquery dep here
            var info = $.extend({ name: '', wiki: ''}, props);
            this._div.innerHTML = '<h4>Station Information</h4>' + '<h4><strong>' + this._renderlink(info) + '</strong></h4>';
        },
        
        _renderlink: function (info) {
            var link = $('<span></span>').text(info.name).text();
            if (info.wiki) {
//#jquery dep here
                var node = $('<a></a>').attr('alt', info.name).attr('href', '//en.wikipedia.org/wiki/' + info.wiki).text(info.name);
                var parent = $('<div></div>').html(node);
                link = parent.html();
            }
            return link;
        }
    });
    var infowidget = new InfoControl();

    var map = L.map('map', {
        center: [45.757, 4.875],
        zoom: 14,
        layers: [osm, markerLayerGroup],
        zoomControl: false
    });
    L.control.layers(baseLayers, poiLayers, {position: 'bottomright', collapsed: false}).addTo(map);
    L.control.scale().addTo(map);
    map.addControl(infowidget);
    map.addControl(new L.Control.Zoom())



    function getPins(e){
      bounds = map.getBounds();
      url = "parks/within?lat1=" + bounds.getSouthWest().lat + "&lon1=" + bounds.getSouthWest().lng + "&lat2=" + bounds.getNorthEast().lat + "&lon2=" + bounds.getNorthEast().lng;
      $.get(url, pinTheMap, "json")
    }

            var set1_Simul = [{
                pos: [4.88, 45.75],
                name: "ExampleFoo"
            }];
            function whenReadyStatic_Simul(e){
                pinTheMap(set1_Simul);
            }
            function getPins_Simul(e){
              set1_Simul.push({
                pos: [4.86, 45.73],
                name: "ExampleBar"
              });
              pinTheMap(set1_Simul);
            }

    function pinTheMap(data){
      //clear the current pins
      markerLayerGroup.clearLayers();
 
      var redIcon = L.AwesomeMarkers.icon({
        prefix: 'fa',
        icon: 'anchor',
        spin: false,
        markerColor: 'electricblue'
      });
      //add the new pins
      var markerArray = new Array(data.length)
      for (var i = 0; i < data.length; i++){
        park = data[i];
        markerArray[i] = L.marker([park.pos[1], park.pos[0]], {icon: redIcon, nodeInfo: park})
          .bindPopup("<b>Marker:</b> " + park.name)
          .on('mouseover', function(e) {
            infowidget.update(this.options.nodeInfo);
          });  // use .on('mouseout') to clear info if needed
        park = null
      }
markerArray[i] = L.marker(map.options.center);
      markerLayerGroup.addLayer(L.layerGroup(markerArray));
    }

    map.on('dragend', getPins);
    map.on('zoomend', getPins);
    map.whenReady(getPins)

  </script>
  <span id="fossribbon"><a href="https://openshift.redhat.com/app/console/application_types/custom?name=tclmap&initial_git_url=https%3A%2F%2Fgithub.com/mchubby/grandlyon-ibasho-planner.git&cartridges[]=php-5&cartridges[]=mongodb-2">Run me on OpenShift</a></span>
</body>
</html>
